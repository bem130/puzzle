<!DOCTYPE html>
<html>
    <head>
        <title>パズル</title>
        <meta charset="utf-8">

        <meta name="description" content="puzzle">
        <meta name="application-name" content="HarukiSite - puzzle"/>
        <meta name="twitter:site" content="@haruki_1234_">
        <meta name="twitter:card" content="summary_large_image">
        <meta property="og:type" content="website">
        <meta property="og:title" content="puzzle - haruki1234">
        <meta property="og:description" content="パズルを生成できます">
        <meta property="og:site_name" content="HarukiSite">

    </head>
    <body>
        <center>
            <div>
                <h1>
                    パズルを自動生成したい話
                </h1>
                <div>
                    <table>
                        <tr>
                            <td>
                                <p>横のサイズ</p>
                            </td>
                            <td>
                                <input id="xsize" value="10" type="range" max="100" min="5">
                            </td>
                            <td>
                                <p id="xsize_show">10</p>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <p>縦のサイズ</p>
                            </td>
                            <td>
                                <input id="ysize" value="10" type="range" max="100" min="5">
                            </td>
                            <td>
                                <p id="ysize_show">10</p>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <p>ピース数</p>
                            </td>
                            <td>
                                <input id="piecenum" value="20" type="range" max="32" min="3">
                            </td>
                            <td>
                                <p id="piecenum_show">20</p>
                            </td>
                        </tr>
                    </table>
                </div>
                <button onclick="make()">make</button>
                <img id="play" draggable="false">
                <img id="show">
            </div>
        </center>
    </body>
</html>
<script>
    let size,piecenum
    let making = false
    let data
    let holding = false
    let bhpos,hloc

    {
        s_ysize = function(){document.getElementById("ysize_show").innerHTML = document.getElementById("ysize").value};
        s_xsize = function(){document.getElementById("xsize_show").innerHTML = document.getElementById("xsize").value};
        s_piecenum = function(){document.getElementById("piecenum_show").innerHTML = document.getElementById("piecenum").value};
        document.getElementById("ysize").oninput = s_ysize;
        document.getElementById("xsize").oninput = s_xsize;
        document.getElementById("piecenum").oninput = s_piecenum;
        s_ysize();
        s_xsize();
        s_piecenum();
    }

    piececolor = [
        [119,136,153],[25,25,112],[65,105,225],[200,225,155],[0,255,255],[95,158,160],[120,100,100],[178,34,34],[188,143,143],[153,50,204],[221,160,221],[244,164,96],[235,235,0],[210,18,140],[139,69,19],[123,104,238],[210,105,30],[50,205,50],[238,130,238],[240,100,80],[150,81,77],[173,125,76],[71,75,66],[68,97,123],[137,195,235],[22,94,131],[30,80,162],[34,5,112],[130,174,70],[236,109,81],[136,72,152],[151,144,164],
    ]

    make()
    function make() {
        if (making) {
            return;
        }
        making = true;
        size = [Number(document.getElementById("xsize").value),Number(document.getElementById("ysize").value)];
        piecenum = Number(document.getElementById("piecenum").value);
        if (size[0]*size[1]<piecenum) {
            piecenum = size[0]*size[1];
            document.getElementById("piecenum").value = piecenum;
            document.getElementById("piecenum_show").innerHTML = piecenum;
        }

        // 参考 https://qiita.com/qiiChan/items/5179a7e540257d38c181
        let worker = new Worker('makepuzzle.js');
        worker.addEventListener('message', function(e) {
            let wdata = e.data;
            data = wdata[1]
            worker.terminate();
            making = false;
            //madepuzzle();
            playpuzzle();
        }, false);
        worker.postMessage([size,piecenum]);

    }

    function madepuzzle() {
        x = 16*size[0];
        y = 16*size[1];
        iarr = new Uint8ClampedArray(x * y * 4);
        for (iy = 0; iy < y; iy++) {
            for (ix = 0; ix < x; ix++) {
                dx = Math.floor(ix/16);
                dy = Math.floor(iy/16);
                d = piececolor[data[dy][dx]-1];
                index = (iy*x+ix)*4; // index of position [ix,iy]
                iarr[index+0] = d[0]; // Red
                iarr[index+1] = d[1]; // Green
                iarr[index+2] = d[2]; // Blue
                iarr[index+3] = 255; // Alpha
            }
        }
        let canvasOutput = document.createElement("canvas");
        canvasOutput.height = y;
        canvasOutput.width = x;
        canvasOutput.getContext('2d').putImageData(new ImageData(iarr, x, y), 0, 0);
        document.getElementById("show").src = canvasOutput.toDataURL('image/png');
    }

    function getmouse_play() {
        selecting = 0;
        playim = document.getElementById("play");
        playim.oncontextmenu = function () {return false;};
        update = function(e) {
            playims = [playim.clientWidth,playim.clientHeight];
            pfield = [margin[0]*2+size[0],margin[1]*2+size[1]];
            pcp = [Math.floor(e.offsetX/playims[0]*pfield[0]),Math.floor(e.offsetY/playims[1]*pfield[1])];
            if (pcp[0]>=0&pcp[0]<pfield[0] & pcp[1]>=0&pcp[1]<pfield[1]) {
                cursorpos = pcp;
            }
            if (holding) {
                mlen = [e.offsetX-hloc[0],e.offsetY-hloc[1]];
                mblock = [Math.floor(mlen[0]/playims[0]*pfield[0]),Math.floor(mlen[1]/playims[1]*pfield[1])];
                pmd[selecting-1] = [bhpos[0]+mblock[0],bhpos[1]+mblock[1]];
            }
            playpuzzle_show();
            //console.log(selecting)
        }
        mousedown = function(e) {
            pcp = cursorpos;
            ps = 0;
            for (p=0;p<piecenum;p++) {
                if (pd[pindex[p]-1][pcp[1]*16][pcp[0]*16]>0) {
                    ps = pd[pindex[p]-1][pcp[1]*16][pcp[0]*16];
                }
            }
            selecting = ps;

            ppin = pindex;
            if (selecting>0) {
                if (true) {
                    bfppins = ppin[selecting-1]
                    ppin[selecting-1] = piecenum+1;
                    for (p=0;p<piecenum;p++) {
                        if (ppin[p]>bfppins) {
                            ppin[p]-=1
                        }
                    }
                    console.log(ppin,selecting)
                    console.log(pindex,selecting)
                }
                bhpos = pmd[selecting-1];
                hloc = [e.offsetX,e.offsetY];
                holding = true;
            }
        }
        mouseup = function(e) {
            holding = false;
            selecting = 0;
        }
        mouseleave = function(e) {
            holding = false;
            selecting = 0
        }
        playim.addEventListener("mouseenter", update, false);
        playim.addEventListener("mousemove", update, false);
        playim.addEventListener("mouseleave", mouseleave, false);
        playim.addEventListener("mousedown", mousedown, false);
        playim.addEventListener("mouseup", mouseup, false);
    }
    
    function playpuzzle() {
        // moving data
        pmd = [];
        for (p=0;p<piecenum;p++) {
            pmd.push([0,0]);
        }
        // index data
        pindex = [];
        for (i=0;i<piecenum;i++) {
            pindex.push(i+1);
        }
        // cursor data
        cursorpos = [0,0];
        
        playpuzzle_show();
        getmouse_play();
    }

    function playpuzzle_show() {
        margin = [2,2];
        slide = [0,0];
        x = 16*size[0]+margin[0]*16*2;
        y = 16*size[1]+margin[1]*16*2;

        // make play data
        pd = [];
        for (p=0;p<piecenum;p++) {
            let pa = new Array(y);
            for (i=0;i<y;i++) {
                pa[i] = new Array(x).fill(0);
            }
            pd.push(pa);
        }

        for (let i=0;i<y;i++) {
            for (let j=0;j<x;j++) {
                dy = Math.floor(i/16);
                dx = Math.floor(j/16);
                if (data[dy]!=null && data[dy][dx]!=null) {
                    mvp = pmd[data[dy][dx]-1];
                    pd[data[dy][dx]-1][i+margin[1]*16+slide[1]*16+mvp[1]*16][j+margin[0]*16+slide[0]*16+mvp[0]*16] = data[dy][dx];
                }
            }
        }

        // view
        iarr = new Uint8ClampedArray(x * y * 4);
        for (iy = 0; iy < y; iy++) {
            for (ix = 0; ix < x; ix++) {
                index = (iy*x+ix)*4; // index of position [ix,iy]
                if (ix>=margin[0]*16+slide[0]*16&ix<margin[0]*16+size[0]*16+slide[0]*16 & iy>=margin[1]*16+slide[1]*16&iy<margin[1]*16+size[1]*16+slide[1]*16) {
                    iarr[index+0] = 100; // Red
                    iarr[index+1] = 100; // Green
                    iarr[index+2] = 100; // Blue
                    iarr[index+3] = 255; // Alpha
                }
                else {
                    iarr[index+0] = 50; // Red
                    iarr[index+1] = 50; // Green
                    iarr[index+2] = 50; // Blue
                    iarr[index+3] = 255; // Alpha
                }
            }
        }
        for (iy = 0; iy < y; iy++) {
            for (ix = 0; ix < x; ix++) {
                index = (iy*x+ix)*4; // index of position [ix,iy]
                for (p=0;p<piecenum;p++) {
                    d = piececolor[pd[pindex[p]-1][iy][ix]-1]
                    if (d!=null) {
                        iarr[index+0] = d[0]; // Red
                        iarr[index+1] = d[1]; // Green
                        iarr[index+2] = d[2]; // Blue
                        iarr[index+3] = 255; // Alpha
                    }
                }
            }
        }

        // draw cursor

        for (iy = 0; iy < 16; iy++) {
            for (ix = 0; ix < 16; ix++) {
                if ((iy<1|iy>15-1 | ix<1|ix>15-1)) {
                    i = iy+cursorpos[1]*16
                    j = ix+cursorpos[0]*16
                    index = (i*x+j)*4;
                    iarr[index+0] = 255; // Red
                    iarr[index+1] = 255; // Green
                    iarr[index+2] = 255; // Blue
                    iarr[index+3] = 255; // Alpha
                }
            }
        }

        let canvasOutput = document.createElement("canvas");
        canvasOutput.height = y;
        canvasOutput.width = x;
        canvasOutput.getContext('2d').putImageData(new ImageData(iarr, x, y), 0, 0);
        document.getElementById("play").src = canvasOutput.toDataURL('image/png');
    }

</script>
<style>
    button {
        width: 400px;
        height: 70px;
        font-size: 25px;
        margin: 30px;
    }
    table,tr,td {
        margin: 0;
        padding: 0;
        border-width: 0;
    }
    p {
        margin: 5px;
        padding: 1px;
    }
    input {
        width: 400px;
    }
    #play,#show {
        width: 500px;
        image-rendering: pixelated;
        display: block;
        margin: 10px;
        padding: 0px;
    }
</style>


<script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-analytics.js"></script>
<script>
var firebaseConfig = {
    apiKey: "AIzaSyDLLs9K4E9UVTmP2XaHhn_UzXtlN1nCDXc",
    authDomain: "github-b0aea.firebaseapp.com",
    projectId: "github-b0aea",
    storageBucket: "github-b0aea.appspot.com",
    messagingSenderId: "539611850738",
    appId: "1:539611850738:web:57da8d1bd3bcf69a7a2d6b",
    measurementId: "G-F2XPLPFDJ5"
};
firebase.initializeApp(firebaseConfig);
if (location.hostname == "haruki1234.github.io") {
    firebase.analytics();
}
</script>